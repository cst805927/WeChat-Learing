# 第 20 章 小程序UI组件库-基于Vant Weapp的生日管家

- 为了提高小程序的开发效率

  可以考虑使用第三方UI组件来实现界面的视觉统一

  - 开发者可以方便的引用

    已经事先设计好的自定义组件

    来快速搭建小程序页面

## 本章学习目标

- 了解小程序自定义组件的概念
- 掌握UI组件库 Vant Weapp 的下载和使用
- 掌握小程序云开发小程序端数据库的相关 API

## 20.1 小程序自定义组件简介

### 20.1.1 什么是自定义组件

- 小程序支持简洁的组件化编程

- 开发者可以将页面内的功能模块制作成自定义组件

  以便在不同的页面中重复使用

  也可以将复杂内容拆分成若干个低耦合的模块

  这样有助于代码的后期维护

- 例如，目前小程序的原生组件中是没有卡片组件的

  开发者可以自行使用图片、按钮、文本等内容

  通过样式布局组合成一个商品

  然后自由应用于多个页面上

  这种组件就是自定义组件

### 20.1.2 自定义组件的引用方式

- 如果需要开发者自定义组件，

  则需要为每个组件编写一套由WXML、WXSS、JSON以及JS几个文件组成的模块代码

  并且使用前需要在对应页面的JSON文件中进行引用声明

  其语法格式如下：

```
  {
  	"usingComponents": {
    	"component-tag-name": "path/to/the/custom/component"
  	}
  }
```

- 其中“component-tag-name”换成自定义的组件名称

  （也就是未来在页面上引用的组件标签名）

- “path/to/the/component”换成自定义组件所在的路径地址即可使用

- 在完成引用声明后

  自定义组件在使用时与小程序原生的基础组件用法非常相似

### 20.1.3 小程序UI组件库 Vant Weapp

- 这里以有赞小程序组件库 Vant Weapp 为例

  从零开始讲解如何使用其开发完成一款生日管家小项目

- Vant Weapp是一款轻量、可靠的小程序UI组件库，

  与有赞移动端组件库Vant基于相同的视觉规范

  并提供一致的API接口

### 20.1.5 Vant Weapp 的下载和安装

#### 1. 方法一：通过npm安装

```
#通过npm安装
npm i @vant/weapp -S --production
```

- 需要注意的是

  package.json和node_modules必须在 miniprogram目录下

#### 2.方法二：通过git下载源代码

- 手动将其中的dist或lib文件夹复制到项目内的自定义路径地址

```
git clone https://github.com/yozan/vant-weapp.git
```

#### 3. 方法三：直接下载源代码

- 直接访问网页下载源代码，

  解压缩后手动将目录中的dist或lib复制到项目内的自定义路径地址中

## 20.2 需求分析

- 本项目一共需要 3 个页面

  即首页、好友信息编辑页和好友信息展示页

### 20.2.1 首页功能需求

- 首页功能需求如下

  - 首页需要包含“添加新朋友”按钮、搜索框和好友列表

  - 点击“添加新朋友”按钮后跳转到好友信息编辑页，可以录入数据

  - 搜索框可以根据好友姓名关键词查找指定好友

  - 好友生日列表需要展示好友姓名、生日、距离下个生日还有多少天，

    并且点击好友头像可以跳转到好友信息展示页查看详情

### 20.2.2 好友信息编辑页功能需求

- 好友信息编辑页功能需求如下：
  - 以表单的形式要求用户录入好友的姓名、性别、生日、电话、关系等信息
  - “保存记录”按钮用于添加或更新好友数据到云数据库中
  - “取消修改”按钮用于取消本次填写，返回上一页

### 20.2.3 好友信息展示页功能需求

- 好友信息展示页功能需求如下
  - 顶端展示好友的头像和姓名
  - 中间列表展示好友的性别、电话、和用户本人的关系、距离出生已经多少天、距离下个生日还有多少天
  - 下方是“修改”按钮和“删除”按钮，分别用于跳转编辑页面和直接删除当前好友

## 20.3 初始化项目

### 20.3.1 创建云模板项目

- 首先需要创建一个云开发项目，

  在任意盘符下创建一个空白文件夹（birthdayMemo）

  然后填入AppID和选中“小程序”、“云开发”

- 接着删除其中无用的模板代码
  1. 删除cloudFunctions文件夹下的默认云函数login的全部内容
  2. 找到app.json文件，打开并删除其中的页面引用，只保留第一个pages/index/index
  3. 打开硬盘中的pages文件夹，删除index以外的所有目录
  4. 进入index文件夹，删除多余的图片，以及JS、WXML和WXSS文件中的全部代码
  5. 删除app.wxss中的代码
  6. 删除image文件夹中的所有图片
  7. 删除style文件夹
  8. 此时项目清理完成

### 20.3.2 部署云数据库

- 具体操作如下
  1. 打开云开发控制台，创建一个新的数据库，例如birthday
  2. 检查birthday数据集的权限，确认是“仅创建者及管理员可读写”

### 20.3.3 创建页面文件

- 本项目由 3 个页面文件，

  - index（首页）
  - edit（好友信息编辑页）
  - detail（好友信息展示页）

- 打开app.json文件，

  在pages属性中追加edit和detail页面的路径描述

- 保存后自动生成后面两个页面，

### 20.3.4 创建其他文件

- 本项目还需要以下 3 个文件夹
  - images：用于存放图片素材，已存在
  - utils：用于存放公共JS文件，需要手动创建
  - vant-weapp：用于存放有赞UI库的dist目录，需要手动创建

#### 1. 添加图片文件

- 本项目将用到一套动物头像卡通图标为

  新增好友随机生成的头像

- 打开images文件夹，创建二级目录avatar，将头像复制进去

#### 2. 创建公共JS文件

- 点击utils文件夹

  选择新建JS

  创建公共文件utils.js

#### 3. 添加UI组件库

- 右击vant-weapp文件夹，

  将事先下载好的Vant Weapp组件库源代码中的dist目录复制、粘贴进去

- 注意：

  - 最后检查一定要将app.json文件中的"style":"v2"手动删除

    这句代码表示使用小程序新版的基础组件样式

    会对当前UI组件库的部分组件造成样式干扰，影响使用效果

## 20.4 视图设计

#### 20.4.1 导航栏设计

- 用户通过在app.json中

  对window属性进行重新配置

  来自定义导航栏的效果

  app.json

```
{
  "pages": [
    "pages/index/index",
    "pages/detail/detail",
    "pages/edit/edit"
  ],
  "window": {
    "navigationBarBackgroundColor": "#DE6E6D",
    "navigationBarTitleText": "生日管家"
  }
}
```

#### 20.4.2 页面设计

##### 1.首页设计

- 首页主要包含 3 部分内容
  - “添加新朋友”按钮
  - 搜索框
  - 好友列表
- 计划使用如下组件
  - 按钮：Vant Weapp中的按钮组件<van-button>
  - 搜索框：Vant Weapp中的搜索组件<van-search>
  - 好友列表：Vant Weapp中的卡片组件<van-card>
- 首先在 index.json中添加对第三方组件的引用声明

```
{
  "usingComponents": {
    "van-search": "/vant-weapp/dist/search/index",
    "van-card": "/vant-weapp/dist/card/index",
    "van-button": "/vant-weapp/dist/button/index"
  }
}
```

- index.wxml

```
<!-- “添加新朋友”按钮 -->
<van-button type="default">添加新朋友</van-button>
<!-- 搜索框 -->
<van-search placeholder="请输入搜索关键词" show-action bind:search="onSearch" bind:cancel="onCancel" />
<!-- 好友列表 -->
<van-card centered desc="06-23" title="小兔" thumb="/images/avatar/001.png">
  <view slot="footer">
    距离下个生日
    <text style="color:red;font-weight: bold;">100天</text>
  </view>
</van-card>
```

- 这里的好友姓名、头像、生日和距离下次生日多少天

  都是为了演示效果临时填写的

  后续会换成实际录入的好友信息

  并形成列表效果

##### 2. 好友信息编辑页设计

- 好友信息编辑页主要包含一系列表单组件和两个按钮

  - 表单组件主要用于填写好友的姓名、性别、生日、电话和关系
  - 两个按钮分别用于保存或取消当前登记的信息

- 由于没有做点击跳转的逻辑设计

  所以可以在开发工具顶端选择“普通编译”下的“添加编译模式”

- 此时预览就可以直接显示edit页面了

  其它页面也可以这么做

  设计完毕后改回"普通编辑“模式即可重新显示首页

- 计划使用<form>组件进行整体布局，内部包含的组件如下

  - 行：Vant Weapp中的布局组件<van-row>
  - 列：Vant Weapp中的布局组件<van-col>
  - 文本标签：<label>
  - 文本输入框：<input>
  - 单选框：<radio> 和 <radio-group>
  - 日期选择器：<picker>

  - 按钮：<button>

- 首先在edit.json中添加对于第三方组件的引用声明

```
{
  "usingComponents": {
    "vant-row": "/vant-weapp/dist/row/index",
    "vant-col": "/vant-weapp/dist/col/index"
  }
}
```

- 在edit.wxml中添加<form>组件

  并在组件内部使用 Vant Weapp 的布局组件 <van-row>

  将页面分割成 6 行

```
<form>
  <!-- 第1行 -->
  <van-row>
    <van-col span="6"></van-col>
    <van-col span="18"></van-col>
  </van-row>
  <!-- 第2行 -->
  <van-row>
    <van-col span="6"></van-col>
    <van-col span="18"></van-col>
  </van-row>
  <!-- 第3行 -->
  <van-row>
    <van-col span="6"></van-col>
    <van-col span="18"></van-col>
  </van-row>
  <!-- 第4行 -->
  <van-row>
    <van-col span="6"></van-col>
    <van-col span="18"></van-col>
  </van-row>
  <!-- 第5行 -->
  <van-row>
    <van-col span="6"></van-col>
    <van-col span="18"></van-col>
  </van-row>
  <!-- 第6行 -->
  <van-row>
    <van-col span="18" offset="3"></van-col>
    <van-col span="18" offset="3"></van-col>
  </van-row>
</form>
```

- 其中前 5 行用于放置表单组件

  因此在<van-row>组件内部再使用<van-col>组件进行分割

- 开发者需要了解的是<van-row>组件默认被平均分为 24 个栅格

  - 因此可以尝试使用span属性

    将<van-col>再分成 6：18 的比例

    - 其中前 6 格用于放置文本标签
    - 后面 18 格用于放置文本输入框、单选框、日期选择器

- 第 6 行用于放置两个按钮组件

  - 对应的<van-row>组件内部使用<van-col>组件分割成 18 个栅格

  - 并且使用 offset 属性让左边空 3 个栅格

    以便按钮可以居中显示

  - 由于第 2 个按钮所占的比例较多

    会被挤到下一行单独显示

- 然后继续在<van-col>组件中添加对应的内容

  修改后的 edit.wxml

```
<form>
  <!-- 第1行 -->
  <van-row>
    <van-col span="6">
      <label>姓名</label>
    </van-col>
    <van-col span="18">
      <input name="name" placeholder="请输入姓名"></input>
    </van-col>
  </van-row>
  <!-- 第2行 -->
  <van-row>
    <van-col span="6">
      <label>性别</label>
    </van-col>
    <van-col span="18">
      <radio-group name="gender">
        <radio color="#DE6E6D" value="1" />男
        <radio color="#DE6E6D" value="2" />女
      </radio-group>
    </van-col>
  </van-row>
  <!-- 第3行 -->
  <van-row>
    <van-col span="6">
      <label>生日</label>
    </van-col>
    <van-col span="18">
      <picker name="birthday" mode="date">
        <view>{{date}}</view>
      </picker>
    </van-col>
  </van-row>
  <!-- 第4行 -->
  <van-row>
    <van-col span="6">
      <label>电话</label>
    </van-col>
    <van-col span="18">
      <input name="tel" type="number" placeholder="请输入联系电话"></input>
    </van-col>
  </van-row>
  <!-- 第5行 -->
  <van-row>
    <van-col span="6">
      <label>关系</label>
    </van-col>
    <van-col span="18">
      <input name="relationship" placeholder="描述你们的关系"></input>
    </van-col>
  </van-row>
  <!-- 第6行 -->
  <van-row>
    <van-col span="18" offset="3">
      <button>保存记录</button>
    </van-col>
    <van-col span="18" offset="3">
      <button>取消修改</button>
    </van-col>
  </van-row>
</form>
```

- edit.wxss

```
/* 行布局 */
van-row {
  margin: 20rpx 20rpx;
  text-align: center;
}

/* 文本标签 */
label {
  padding: 10rpx;
  color: #de6e6d;
  line-height: 80rpx;
}

/* 文本输入框 */
input {
  border: 1rpx solid #de6e6d;
  width: 480rpx;
  height: 80rpx;
  border-radius: 20rpx;
}

/* 单选按钮 */
radio-group {
  width: 480rpx;
  line-height: 80rpx;
}

/* 单选框 */
radio {
  margin: 0 20rpx;
}

/* 日期选择器中的view */
picker view {
  width: 480rpx;
  line-height: 80rpx;
}

/* 按钮 */
button {
  margin: 20rpx;
  background-color: #de6e6d;
  color: white;
}
```

- 为了进行样式效果的预览

  还需要在 JS 文件中的 data 中录入日期选择器的提示语句

  edit.js

```
// pages/edit/edit.js
Page({

    /**
     * 页面的初始数据
     */
    data: {
        date: '点击设置生日'
    }
})
```

##### 3. 好友信息展示页设计

- 好友信息展示页用于给用户浏览好友详细信息

  需要用户点击首页的好友列表

  然后再新窗口中打开该页面

- 好友信息展示页包括好友的头像、姓名、性别、生日、电话、关系、距离出生的天数、距离下一个生日的天数，

  以及”修改“按钮和”删除“按钮

- 计划将整个页面分为 3 个部分，解释如下
  - 顶端头像和姓名：<image>和<view>
  - 中间个人信息数据：Vant Weapp 中的单元格组件<van-cell-group>和<van-cell>
  - 底部的两个按钮：Vant Weapp 中的按钮组件 <van-button>
- 首先在 detail.json 中添加对于第三方组件的引用声明

```
{
  "usingComponents": {
    "van-button": "/vant-weapp/dist/button/index",
    "van-cell": "/vant-weapp/dist/cell/index",
    "van-cell-group": "/vant-weapp/dist/cell-group/index"
  }
}
```

- detail.wxml

```
<!-- 顶端头像和姓名 -->
<view>
  <image src="/images/avatar/001.png"></image>
  <view>测试好友</view>
</view>
<!-- 个人信息展示 -->
<can-cell-group>
  <van-cell title="性别" value="女" />
  <van-cell title="生日" value="1991-10-10" />
  <van-cell title="电话" value="1234567" />
  <van-cell title="关系" value="同学" />
  <van-cell title="距离出生已经" value="10076天" />
  <van-cell title="距离下个生日还有" value="50天" />
</can-cell-group>
<!-- 按钮区域 -->
<van-button block type="warning">修改</van-button>
<van-button block type="danger">删除</van-button>
```

- detail.wxss

```
/* 头像和姓名区域 */
.avatarBox {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* 头像图片 */
.avatarBox image {
  width: 200rpx;
  height: 200rpx;
  margin: 20rpx;
}

/* 姓名 */
.avatarBox view {
  margin-bottom: 50rpx;
}
```

## 20.5 逻辑实现

### 20.5.1 公共逻辑

#### 1. utils.js 文件逻辑

- 在公共 JS 文件 utils.js 中添加自定义函数 getToday

  用于获取当前格式化日期

  相关函数如下

```
// 获取当前格式化日期
function getToday() {
  // 获取当前日期对象
  let now = new Date()
  // 获取当前年份（4 位数）
  let y = now.getFullYear()
  // 获取当前月份
  let m = now.getMonth() + 1
  // 获取当前日期
  let d = now.getDate()
  // 格式化当天日期
  let today = y + '/' + m + '/' + d
  return today
}
```

- 在utils.js中添加自定义函数 getFullYear

  用于获取当前年份（4 位数）

```
// 获取当前年份（4位数）
function getFullYear() {
  // 获取当前日期对象
  let now = new Date()
  // 获取当前年份（4位数）
  let y = now.getFullYear()
  return y
}
```

- 在utils.js中添加自定义函数 dateDiff

  用于计算两个日期之间的天数差